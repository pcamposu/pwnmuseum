require 'rails_helper'

RSpec.describe Exploit, type: :model do
  describe "associations" do
    it { should belong_to(:platform) }
    it { should have_many(:credits).dependent(:destroy) }
    it { should have_many(:hackers).through(:credits) }
  end

  describe "validations" do
    subject { build(:exploit) }

    it { should validate_presence_of(:title) }
    it { should validate_presence_of(:date_discovered) }
    it { should validate_presence_of(:platform) }
  end

  describe "enums" do
    it "has correct impact levels" do
      expect(Exploit.impact_levels).to eq({
        "user_mode" => 0,
        "kernel_mode" => 1,
        "hypervisor" => 2,
        "bootrom" => 3
      })
    end

    it "correctly identifies user mode exploits" do
      exploit = build(:exploit, impact_level: 0)
      expect(exploit.impact_level_user_mode?).to be true
      expect(exploit.impact_level_kernel_mode?).to be false
    end

    it "correctly identifies kernel mode exploits" do
      exploit = build(:exploit, impact_level: 1)
      expect(exploit.impact_level_kernel_mode?).to be true
      expect(exploit.impact_level_user_mode?).to be false
    end

    it "correctly identifies hypervisor exploits" do
      exploit = build(:exploit, impact_level: 2)
      expect(exploit.impact_level_hypervisor?).to be true
      expect(exploit.impact_level_kernel_mode?).to be false
    end

    it "correctly identifies bootrom exploits" do
      exploit = build(:exploit, impact_level: 3)
      expect(exploit.impact_level_bootrom?).to be true
      expect(exploit.impact_level_hypervisor?).to be false
    end
  end

  describe "scopes" do
    it "returns exploits in chronological order" do
      old = create(:exploit, date_discovered: 5.years.ago.to_date)
      new = create(:exploit, date_discovered: 1.year.ago.to_date)

      expect(Exploit.chronological).to eq([ old, new ])
    end

    it "returns exploits by impact level" do
      user = create(:exploit, impact_level: 0)
      bootrom = create(:exploit, impact_level: 3)

      expect(Exploit.where(impact_level: 0)).to eq([ user ])
      expect(Exploit.where(impact_level: 3)).to eq([ bootrom ])
    end
  end

  describe "XSS protection" do
    it "sanitizes script tags in description" do
      platform = create(:platform)
      exploit = build(:exploit,
        platform: platform,
        description: "<script>alert('XSS')</script>Safe text"
      )

      expect(exploit.save).to be true
      expect(exploit.description).not_to include("<script>")
      expect(exploit.description).to include("Safe text")
    end

    it "sanitizes onerror attributes in description" do
      platform = create(:platform)
      exploit = build(:exploit,
        platform: platform,
        description: "<img src=x onerror=alert('XSS')>Safe text"
      )

      expect(exploit.save).to be true
      expect(exploit.description).not_to include("onerror")
      expect(exploit.description).to include("Safe text")
    end

    it "allows safe HTML formatting" do
      platform = create(:platform)
      exploit = build(:exploit,
        platform: platform,
        description: "<strong>Bold</strong> and <em>italic</em> text"
      )

      expect(exploit.save).to be true
      expect(exploit.description).to include("<strong>Bold</strong>")
      expect(exploit.description).to include("<em>italic</em>")
    end

    it "preserves line breaks as text (not HTML)" do
      platform = create(:platform)
      exploit = build(:exploit,
        platform: platform,
        description: "First paragraph\n\nSecond paragraph"
      )

      expect(exploit.save).to be true
      expect(exploit.description).to include("First paragraph")
      expect(exploit.description).to include("Second paragraph")
    end
  end
end
