# Represents a security vulnerability discovered in a gaming console.
#
# An exploit documents the technical details of a security breach, including its
# impact level (user mode through bootrom), discovery date, and the hackers
# credited with its discovery.
#
# @see https://guides.rubyonrails.org/associations.html Rails Associations
# @see https://api.rubyonrails.org/classes/ActiveModel/Validations.html Rails Validations
class Exploit < ApplicationRecord
  belongs_to :platform
  has_many :credits, dependent: :destroy
  has_many :hackers, through: :credits

  # Why: Title is required for historical documentation and searchability.
  # A vulnerability without a descriptive name cannot be properly referenced
  # or cited in security research.
  validates :title, presence: true

  # Why: Date discovered establishes chronological context for timeline
  # visualization and historical analysis of console security evolution.
  # Required to order exploits temporally and analyze security trends.
  validates :date_discovered, presence: true

  # Why: Platform association is mandatory to categorize exploits by
  # console manufacturer and enable proper filtering in the timeline view.
  # Every exploit must be attributable to a specific gaming platform.
  validates :platform, presence: true

  # Impact levels ranked from least to most severe
  # Integer values persist to database for efficient querying
  enum :impact_level, {
    user_mode: 0,
    kernel_mode: 1,
    hypervisor: 2,
    bootrom: 3
  }, prefix: true

  scope :chronological, -> { order(:date_discovered) }

  # Why: User-submitted HTML descriptions must be sanitized to prevent XSS attacks.
  # Malicious actors could inject scripts through exploit descriptions.
  # Rails' SafeListSanitizer allows only formatting tags, stripping scripts.
  before_validation :sanitize_description

  private

  # Sanitize HTML to prevent XSS while preserving formatting.
  # Permits safe HTML tags for rich text descriptions.
  def sanitize_description
    return unless description.present?

    # SafeListSanitizer removes dangerous elements (scripts, iframes, etc.)
    # while allowing safe formatting tags (p, br, strong, em, etc.)
    sanitizer = Rails::Html::SafeListSanitizer.new
    self.description = sanitizer.sanitize(
      description,
      tags: %w[p br strong em a ul ol li h1 h2 h3 h4 h5 h6 blockquote code pre],
      attributes: %w[href title]
    )
  end
end
