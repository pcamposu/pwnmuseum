# Handles HTTP requests for exploit resources nested under platforms.
#
# Exploits are always accessed within the context of a platform
# (e.g., /platforms/wii/exploits/1). This controller manages
# CRUD operations and renders responses for the interactive timeline.
#
# @see https://guides.rubyonrails.org/layouts_and_rendering.html Rendering
class ExploitsController < ApplicationController
  before_action :set_platform
  before_action :set_exploit, only: [ :show, :edit, :update, :destroy ]

  # Displays exploit details in a modal via Turbo Stream.
  # Why: Use turbo_stream for dynamic modal updates without page refresh,
  # preserving the timeline state and providing a seamless user experience.
  #
  # @return [void] Renders turbo_stream template for modal display
  def show
    respond_to do |format|
      format.turbo_stream
    end
  end

  # Renders form for creating a new exploit within the platform context.
  #
  # @return [void] Renders the new view with @exploit built through platform association
  def new
    @exploit = @platform.exploits.build
  end

  # Creates a new exploit and associates it with the platform.
  # Why: Build exploit through platform association to ensure foreign key
  # is set automatically and validation passes.
  #
  # @param exploit_params [ActionController::Parameters] Whitelisted exploit attributes
  # @return [void] Redirects to platform show page on success, renders :new on failure
  def create
    @exploit = @platform.exploits.build(exploit_params)

    if @exploit.save
      redirect_to platform_path(slug: @platform.slug), notice: "Exploit created successfully."
    else
      render :new, status: :unprocessable_entity
    end
  end

  # Renders form for editing an existing exploit.
  #
  # @return [void] Renders the edit view with @exploit populated
  def edit
  end

  # Updates an existing exploit with provided parameters.
  # Why: Redirect to platform view to show updated exploit in timeline context.
  #
  # @param exploit_params [ActionController::Parameters] Whitelisted exploit attributes
  # @return [void] Redirects to platform show page on success, renders :edit on failure
  def update
    if @exploit.update(exploit_params)
      redirect_to platform_path(slug: @platform.slug), notice: "Exploit updated successfully."
    else
      render :edit, status: :unprocessable_entity
    end
  end

  # Removes an exploit from the database.
  # Why: Dependent destroy on credits ensures referential integrity is maintained.
  #
  # @return [void] Redirects to platform show page after deletion
  def destroy
    @exploit.destroy
    redirect_to platform_path(slug: @platform.slug), notice: "Exploit deleted successfully."
  end

  private

  # Retrieves the parent platform by slug from URL parameters.
  # Why: Slug-based lookup provides human-readable URLs and SEO benefits.
  # Raises ActiveRecord::RecordNotFound if slug doesn't exist.
  #
  # @return [void] Sets @platform instance variable
  # @raise [ActiveRecord::RecordNotFound] If platform_slug doesn't exist in database
  def set_platform
    @platform = Platform.find_by!(slug: params[:platform_slug])
  end

  # Retrieves the specific exploit within the platform context.
  # Why: Scoping to platform ensures exploit belongs to the correct platform
  # and prevents ID enumeration across platforms.
  #
  # @return [void] Sets @exploit instance variable
  # @raise [ActiveRecord::RecordNotFound] If exploit ID doesn't exist within this platform
  def set_exploit
    @exploit = @platform.exploits.find(params[:id])
  end

  # Whitelists permitted parameters for exploit mass assignment.
  # Why: Strong parameters prevent mass assignment vulnerabilities by only
  # allowing explicitly permitted attributes.
  #
  # @return [ActionController::Parameters] Permitted exploit attributes including hacker_ids array
  # TODO: Add frontend validation for media_url format (YouTube, Vimeo, direct links)
  def exploit_params
    params.require(:exploit).permit(:title, :cve_id, :date_discovered, :description, :impact_level, :media_url, hacker_ids: [])
  end
end
